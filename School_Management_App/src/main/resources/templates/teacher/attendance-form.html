<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Mark Attendance - School Management System</title>
</head>
<body>
    <section>
        <div class="card">
            <div class="card-header">
                <h3>Mark Attendance</h3>
            </div>
            <div class="card-body">
                <!-- Course Selection -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="courseSelect" class="form-label">Course:</label>
                        <div class="form-control" id="courseSelect" readonly>
                            <span th:text="${course.name + ' (' + course.code + ')'}"></span>
                            <input type="hidden" name="courseId" th:value="${course.id}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="attendanceDate" class="form-label">Date:</label>
                        <input type="date" class="form-control" id="attendanceDate" 
                               th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                               onchange="loadStudents()">
                    </div>
                    <div class="col-md-4">
                        <label for="scheduleSelect" class="form-label">Schedule:</label>
                        <select class="form-select" id="scheduleSelect" name="scheduleId">
                            <option value="">-- Select Schedule --</option>
                            <option th:each="schedule : ${schedules}" 
                                    th:value="${schedule.id}" 
                                    th:text="${schedule.dayOfWeek + ' ' + #temporals.format(schedule.startTime, 'HH:mm') + '-' + #temporals.format(schedule.endTime, 'HH:mm') + ' (' + schedule.classroom + ')'}">
                                Monday 09:00-10:30 (Room 101)
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Time Window Information -->
                <div id="timeWindowInfo" class="mb-4"></div>

                <form th:if="${not #lists.isEmpty(students)}" 
                      th:action="@{/teacher/attendance/submit}" 
                      method="post" 
                      id="attendanceForm">
                    
                    <input type="hidden" name="courseId" id="courseId">
                    <input type="hidden" name="date" id="dateInput">
                    <input type="hidden" name="scheduleId" id="scheduleIdInput">
                    
                    <script>
                        // Set values when document loads
                        document.addEventListener('DOMContentLoaded', function() {
                            const courseIdHidden = document.querySelector("input[name='courseId'][type='hidden']:not(#courseId)").value;
                            const date = document.getElementById('attendanceDate').value;
                            
                            // Set the values in the form's hidden fields
                            document.getElementById('courseId').value = courseIdHidden;
                            document.getElementById('dateInput').value = date;
                            
                            // Add event listener for schedule select change
                            document.getElementById('scheduleSelect').addEventListener('change', function() {
                                document.getElementById('scheduleIdInput').value = this.value;
                            });
                        });
                    </script>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Roll Number</th>
                                    <th>Student Name</th>
                                    <th>Present</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="student, stat : ${students}">
                                    <td th:text="${student.rollNumber}"></td>
                                    <td th:text="${student.firstName + ' ' + student.lastName}"></td>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   th:name="'attendances[' + ${stat.index} + '].present'"
                                                   th:checked="${student.present}">
                                            <input type="hidden" 
                                                   th:name="'attendances[' + ${stat.index} + '].studentId'"
                                                   th:value="${student.id}">
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm"
                                               th:name="'attendances[' + ${stat.index} + '].remarks'"
                                               placeholder="Optional remarks">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">Back</button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="markAllPresent()">
                                Mark All Present
                            </button>
                            <button type="submit" class="btn btn-primary">Save Attendance</button>
                        </div>
                    </div>
                </form>

                <div th:if="${#lists.isEmpty(students) and selectedCourseId != null}" 
                     class="alert alert-info text-center">
                    No students found for the selected course.
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            function loadStudents() {
                const courseId = document.getElementById('courseSelect').value;
                const date = document.getElementById('attendanceDate').value;
                if (courseId && date) {
                    window.location.href = `/teacher/attendance?courseId=${courseId}&date=${date}`;
                }
            }

            function markAllPresent() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = true);
            }

            window.onload = function() {
                const courseIdHidden = document.querySelector("input[name='courseId']").value;
                const date = document.getElementById('attendanceDate').value;
                
                // Set the values in the form's hidden fields
                document.getElementById('courseId').value = courseIdHidden;
                document.getElementById('dateInput').value = date;
            };
        </script>
        <script th:src="@{/js/attendance-form-validation.js}"></script>
    </section>
</body>
</html>
